<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>VeryCD版电驴(eMule)存在封锁</title>

  
  
  <link rel="stylesheet" href="http://shell909090.org/css/hugo-octopress.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link href="http://shell909090.org/favicon.png" rel="icon">

  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="">

  
  <meta name="generator" content="Hugo 0.17-DEV" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://shell909090.org/">Shell&#39;s Home</a></h1>
    <h2></h2>
</hgroup></header>


<nav role="navigation">

<ul class="main-navigation">
  
  
</ul>


<ul class="subscription">
  

  
  

</ul>


</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
    <h1 class="entry-title">
         VeryCD版电驴(eMule)存在封锁 
    </h1>
    <p class="meta">Sep 24, 2008
         - 4 minute read 
         - <a href="http://shell909090.org/blog/archives/38/#disqus_thread">Comments</a>

        
    </p>
</header>


        <div class="entry-content">
          
          
          
          <p>eMule是一个GPL程序，所以VeryCD的改版必须公开源码。今天听说VeryCD版有封锁的现象，所以贝壳抓源码来看看。如果大家认为老调重弹的话，不妨把文章拉到最后。
源码从此处下载：<a href="http://www.emule.org.cn/download/">http://www.emule.org.cn/download/</a>
最下方链接：<a href="http://download.verycd.com/eMule-VeryCD-src.rar">http://download.verycd.com/eMule-VeryCD-src.rar</a>
贝壳下到的文件大小13,703,064字节，打包时间2008-09-11。经过贝壳查找，在eMule-VeryCD-srcsrc WordFilter发现两个文件，WordFilter.cpp 2008-03-12 09:57 13374和WordFilter.h
2007-11-20 17:56 1009。仔细阅读里面，发现有以下内容。
void    CWordFilter::Init()
{
HANDLE    hFile;
DWORD    dwRead;
int        nLen;
BOOL    bResult;
CStringList list;</p>

<p>//m_count = 0;</p>

<p>CString saaa = thePrefs.GetMuleDirectory(EMULE_EXECUTEABLEDIR) + FLITER_FILE;
CString sbbb = thePrefs.GetMuleDirectory(EMULE_CONFIGDIR) + FLITER_FILE;</p>

<p>// 如果文件目录不对，程序移动一下，到config目录下 added by kernel1983 2006.07.31
if (PathFileExists(thePrefs.GetMuleDirectory(EMULE_EXECUTEABLEDIR) + FLITER_FILE))
MoveFile(thePrefs.GetMuleDirectory(EMULE_EXECUTEABLEDIR) + FLITER_FILE, thePrefs.GetMuleDirectory(EMULE_CONFIGDIR) + FLITER_FILE);</p>

<p>if (!PathFileExists(thePrefs.GetMuleDirectory(EMULE_CONFIGDIR) + FLITER_FILE))
{
// 不存在，所有的都过滤 added by kernel1983 2006.08.08
m_filterall = true;
return;
}</p>

<p>// Open file for read
hFile = CreateFile(thePrefs.GetMuleDirectory(EMULE_CONFIGDIR) + FLITER_FILE, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
//AddLogLine(false,_T(&rdquo;:%sn&rdquo;),thePrefs.GetConfigDir() + FLITER_FILE);
if(hFile == NULL || hFile == INVALID_HANDLE_VALUE)
{
// 读取错误，所有的都过滤 added by kernel1983 2006.08.08
m_filterall = true;
return;
}</p>

<p>DWORD dwSize = GetFileSize(hFile, NULL);</p>

<p>TCHAR * pszData = new TCHAR[(dwSize / sizeof(TCHAR)) + 1];            // 申请空间
bResult = ReadFile(hFile, pszData, dwSize, &amp;dwRead, NULL);        // 读入文件1
CloseHandle(hFile);
pszData[(dwSize / sizeof(TCHAR))] = 0;</p>

<p>if(bResult)
{
// 加入解码算法
{
std::string tempstr( (char*)pszData + 1 , ((int)dwSize - 1) &gt; 0 ? dwSize -1 : 0 );</p>

<p>// 查看是否是老格式
char * pszData_a = (char*) pszData;</p>

<p>if( pszData_a[0] != 0x15 ) {
// 老格式，进行转换
CUnicodeToMultiByte wc2mb( thePrefs.GetMuleDirectory(EMULE_CONFIGDIR) + FLITER_FILE );
tempstr.assign( (char*)pszData , dwSize );
InternalBase64::encode2file( tempstr , std::string((LPCSTR)wc2mb , wc2mb.GetLength()) );</p>

<p>delete [] pszData;
// 重新载入
return Init();
}</p>

<p>vector vec = InternalBase64::decode( tempstr );
char * pszt = (char*) pszData;
for( size_t i = 0; i &lt; vec.size() ; i++ ) {
pszt[i] = vec[i];
}
dwSize = vec.size();
}</p>

<p>TCHAR * pszTemp = wcstok(pszData + 1, _T(&ldquo;rn&rdquo;));
while(pszTemp != NULL)
{
nLen = wcslen(pszTemp);
while(pszTemp[nLen - 1] == &rsquo;t&rsquo; || pszTemp[nLen - 1] == &lsquo; &lsquo;)
{
nLen &ndash;;
pszTemp[nLen] = 0;
}
while(*pszTemp == &rsquo;t&rsquo; || <em>pszTemp == &lsquo; &lsquo;)
{
pszTemp ++;
nLen &ndash;;
}
//AddLogLine(false,_T(&ldquo;pszTemp:%s&rdquo;),pszTemp);
//AddLogLine(false,_T(&ldquo;nLen:%d&rdquo;),nLen);
if(nLen &gt; 0)list.AddTail(pszTemp);
//if(nLen == 8)AddLogLine(false,_T(&rdquo;:%d %d %d %d &ldquo;),((char</em>)pszTemp)[0],((char<em>)pszTemp)[1],((char</em>)pszTemp)[2],((char*)pszTemp)[3]);
pszTemp = wcstok(NULL, _T(&ldquo;rn&rdquo;));
}
}</p>

<p>delete[] pszData;</p>

<p>m_count = list.GetCount();
//AddLogLine(false,_T(&ldquo;m_count:%d&rdquo;),m_count);</p>

<p>if(bResult &amp;&amp; m_count &gt; 0)
{
m_filterwords = new TCHAR<em>[m_count+1];
m_kmpvalue = new int</em>[m_count+1];
ZeroMemory(m_filterwords, sizeof(TCHAR *) * m_count);
ZeroMemory(m_kmpvalue, sizeof(int *) * m_count);
}</p>

<p>for(int i = 0; bResult &amp;&amp; (i &lt; m_count); i ++)
{
CString s = list.GetAt(list.FindIndex(i));
s.MakeLower();
nLen = s.GetLength();
//AddLogLine(false,_T(&ldquo;nLen:%d&rdquo;),nLen);
m_filterwords[i] = new TCHAR[nLen + 1];
m_filterwords[i][nLen] = 0;    // 最后一个字节设为0
m_kmpvalue[i] = new int[nLen];
//AddLogLine(false,_T(&ldquo;nLen:%d&rdquo;),nLen);
_tcscpy(m_filterwords[i],s);
//AddLogLine(false,_T(&ldquo;m_filterwords[i]:%s&rdquo;),m_filterwords[i]);
KMP_GetNext(m_filterwords[i], m_kmpvalue[i]);    // 得到一个与内容有关的数值m_kmpvalue[i]
}</p>

<p>if(m_count == 0 || !bResult)
{
Free();
//m_filterall = true;
}
}</p>

<p>bool    CWordFilter::VerifyString(const CString &amp; sString)    // 验证字符是否合法
{
bool bIsRm = sString.Right(3)==_T(&ldquo;.rm&rdquo;);
CString sReduceString=sString;
CString sInterpunctionString = _T(&ldquo;（），().。·；：－《》『』～　“”〓！【】★×┇&rdquo;);
try // VC-Huby[2007-03-20]:满足中国国情特色,加强过滤
{
int j=0;
for( int i=0; i&lt; sString.GetLength(); i++ )
{
if( sString.GetAt(i)&lt;=_T(&lsquo;/&rsquo;) &amp;&amp; sString.GetAt(i)&gt;=_T(&rsquo; &lsquo;) ) //从空格到&rsquo;/&lsquo;之间的字符减掉后再过滤
{
continue;
}
else if( sString.GetAt(i)&lt;=_T(&lsquo;@&rsquo;) &amp;&amp; sString.GetAt(i)&gt;=_T(&rsquo;:&lsquo;) )
{
continue;
}
else if( sString.GetAt(i)&lt;=_T(&rsquo;`&lsquo;) &amp;&amp; sString.GetAt(i)&gt;=_T(&rsquo;[&lsquo;) )
{
continue;
}
else if( sString.GetAt(i)&lt;=_T(&rsquo;~&lsquo;) &amp;&amp; sString.GetAt(i)&gt;=_T(&lsquo;{&rsquo;) )
{
continue;
}
else if( sInterpunctionString.Find(sString.GetAt(i))&gt;=0 )
{
continue;
}
else
{
sReduceString.SetAt(j,sString.GetAt(i));
j++;
}
}
if( j&lt; sString.GetLength() )
sReduceString.SetAt(j,_T(&ldquo;));
}
catch (&hellip;)
{
}</p>

<p>if(m_filterall){
//AddLogLine(false,_T(&ldquo;m_filterall&rdquo;));
return true;    // 检测不到文件，或者读取错误的情况下放弃过滤
}
if(m_count == 0){
//AddLogLine(false,_T(&ldquo;m_count == 0&rdquo;));
return true;    // 文件是空的时候，放弃过滤功能
}
CString strSearch = ((CString)sReduceString).MakeLower();</p>

<p>//vc-huby: 过滤中文字符超过15字符
//CString sReduceString2=strSearch;
int k=0;
for( int i=0; i&lt; strSearch.GetLength(); i++ )
{
if( strSearch.GetAt(i)&lt;=_T(&lsquo;9&rsquo;) &amp;&amp; strSearch.GetAt(i)&gt;=_T(&lsquo;0&rsquo;) )
{
continue;
}
if( strSearch.GetAt(i)&lt;=_T(&lsquo;z&rsquo;) &amp;&amp; strSearch.GetAt(i)&gt;=_T(&lsquo;a&rsquo;) )
{
continue;
}
else
{
k++;
}
}</p>

<p>if( k&gt;=20 &amp;&amp; bIsRm )
return false;
//int m = sReduceString2.GetLength();
/*
if( k&gt;=60 )
return false;*/</p>

<p>/<em>if (strSearch.GetLength() &gt; 20)
{
return false;
}</em>/</p>

<p>for(int i = 0; i &lt; m_count; i ++)
{
if(KMP_Match(strSearch, m_filterwords[i], m_kmpvalue[i]))
{
//AddLogLine(false,_T(&ldquo;KMP_Match&rdquo;));
return false;    // 关键词命中了，被fliter了
}
}
//AddLogLine(false,_T(&ldquo;漏掉的&rdquo;));
return true;</p>

<p>}</p>

<p>void CWordFilter::Free()    //
{
for(int i = 0; i &lt; m_count; i ++)
{
if(m_filterwords[i])
delete[] m_filterwords[i];
if(m_kmpvalue[i])
delete[] m_kmpvalue[i];
}
delete[] m_filterwords;
delete[] m_kmpvalue;
}</p>

<p>CWordFilter::~CWordFilter()
{
Free();
}
其中WordFilter.h的第17行有以下定义。
#define FLITER_FILE _T(&ldquo;wordfilter.txt&rdquo;)
于是贝壳查看了C:Program FileseMuleconfig目录，在下面发现了wordfilter.txt 2007-09-30 12:58 10788。大家有兴趣自己看看里面的内容，贝壳就不贴了，贴出来绝对被封，死1090次。
下面说一点起效方式，也许大家很奇怪，这些内容是可以搜索的。贝壳仔细查看了代码，类在两处被引用了，一个是MFC初始化系统的时候初始化类，载入词典。另外一个是在SearchList.cpp 2007-11-20 17:56 22505，351行AddToList函数，第360行，内容如下。
// WordFilter added by kernel1983 2006.07.31
if(!WordFilter.VerifyString(toadd-&gt;GetFileName()))
{
delete toadd;
return false;
}
这个封锁手法尤其狠毒，并非封锁你的搜索，而是如果你的文件信息内有这些关键词，那么文件共享消息就不会被发送到服务器上，如同这个文件没有被共享一样。这样既没有用户会发现被封锁的事实(因为有少量其他客户端的数据会被检索出来)，又能达到封锁的目地。
当然，贝壳理解VeryCD这帮人的苦心，毕竟他们还住在中国，不过估计从此后，贝壳和朋友的机器上不会装VeryCD了。</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn"></span></span>
    
    <time>Sep 24, 2008</time>
    <span class="categories">
      Tags:
        
        
          <a class="category" href="http://shell909090.org/tags/computer">computer</a>  <a class="category" href="http://shell909090.org/tags/emule">emule</a>  <a class="category" href="http://shell909090.org/tags/filter">filter</a>  <a class="category" href="http://shell909090.org/tags/verycd">verycd</a>  <a class="category" href="http://shell909090.org/tags/%e5%b0%81%e9%94%81">%e5%b0%81%e9%94%81</a>  
        
    </span>
  </p>

  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://shell909090.org/blog/archives/37/" title="百度、官员辞职和特供局">百度、官员辞职和特供局</a>
    

    
      <a class="basic-alignment right" href="http://shell909090.org/blog/archives/39/" title="苏博婚礼回来暨python2.6发布">苏博婚礼回来暨python2.6发布</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'shell909090blog';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      
      
      
       
      
      
      
      
      

    
    
    </li>
  </ul>

  

  

  
  
  
    <section class="even">
      <h1>Recent Posts</h1>
      <ul id="recent_posts">
        
          <li class="post">
            <a href="/blog/archives/2836/">Pulau Perhentian</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2835/">唐僧被吃了</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2832/">三亚潜水体验</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2829/">潜水的一些简单解说</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2822/">一个有趣的问题</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2820/">一次升级故障的排查</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2816/">关于程序员和产品经理两大世界体系的对话——论快播庭审</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2813/">云计算的成本计算</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2809/">说说密码和安全设计</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2806/">从青蒿素得奖说现代医学里的方法论</a>
          </li>
        
      </ul>
    </section>
  

</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2016  - <a href="http://shell909090.org/license/">License</a> -
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


</body>
</html>

