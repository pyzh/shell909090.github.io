<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>debian live</title>

  
  
  <link rel="stylesheet" href="http://shell909090.org/css/hugo-octopress.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link href="http://shell909090.org/favicon.png" rel="icon">

  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="">

  
  <meta name="generator" content="Hugo 0.17-DEV" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://shell909090.org/">Shell&#39;s Home</a></h1>
    <h2></h2>
</hgroup></header>


<nav role="navigation">

<ul class="main-navigation">
  
  
</ul>


<ul class="subscription">
  

  
  

</ul>


</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
    <h1 class="entry-title">
         debian live 
    </h1>
    <p class="meta">Jul 11, 2006
         - 2 minute read 
         - <a href="http://shell909090.org/blog/archives/307/#disqus_thread">Comments</a>

        
    </p>
</header>


        <div class="entry-content">
          
          
          
          <p><div>    准备做debian live了，期间有什么东西都会写在这里。大致来说就是打算实践一个项目。<br />copyright<br />    Shell.E.Xu撰写，按GPL发布。<br />abstract<br />    用debian3.1testing为基础建立live cd。128M以内，无X系统，无交换区和/tmp，使用内存盘。<br />target<br />    用于挂载ext3 ntfs vfat文件系统，实施文件系统管理和修复，访问文件系统内容并修改。<br />    注：准备特别针对3721，yahoo助手之类类似rootkit的东西实施扫描清理。<br />environment<br />    debian 3.1 starg testing（貌似是废话）<br />    grub stage2_eltorito支持光盘启动<br />    linux-kernel-2.6.15-8 直接使用deb包中内容<br />    initrd 在kernel包中包含<br />step by step<br />    1.建立基础文件系统并且复制所需文件<br />        建立~/syscd/boot/grub/，复制menu.lst stage2_eltorito文件过去。<br />        复制vmlinuz system.map config到~/syscd/boot中，注意ISO9660格式中文件名不能过长（多少记不清了）。<br />        复制/lib到~/syscd/lib，并且调节内容。（我个人在其中添加了我需要的nVIDIA显卡驱动）<br />    2.grub和iso<br />        cd ~<br />        mkdir initrd<br />        #关于initrd的原理生成和使用后面讲<br />        mkdir root<br />        #这个是用于内存的镜像内容<br />        mkdir cramfs<br />        #这个是只读镜像内容<br />        vi ~/testsyscd<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br />#!/bin/bash<br />qemu -no-kqemu -cdrom ~/syscd.iso -boot d &gt;/dev/null <br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br />        chmod 755 ~/testsyscd<br />        vi ~/mksyscd<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br />#!/bin/bash<br />COMPRESS_MODE=-9<br />cd ~<br /># block of create initrd.img, disable when u already get one.<br />cd initrd<br />find . | cpio -H newc -o &gt; ../initrd.img<br />cd ..<br />gzip -c $COMPRESS_MODE initrd.img &gt; syscd/boot/initrd.img<br />rm initrd.img<br /># block of create root.tar.gz, disable when u already get one.<br />cd root<br />tar cvf ../root.tar * &gt;/dev/null 2&gt;&amp;1<br />cd ..<br />gzip -c $COMPRESS_MODE root.tar &gt; syscd/boot/root.tar.gz<br />rm root.tar<br /># mkcramfs<br />mkcramfs cramfs syscd/cdrom.cramfs<br /># block of make iso img<br />mkisofs -R -b boot/grub/stage2_eltorito -no-emul-boot -boot-load-size 4 -boot-info-table -o syscd.iso syscd<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br />        chmod 755 ~/mksyscd<br />        #试验一下<br />        ./mksyscd<br />        如此处理后，运行mksyscd就可以生成我们所需要的iso。不过现在生成的试验品是没有用处的，我们安装了grub和linux内核，可是没有让grub去引导光盘上的内核.<br />        vi ~/syscd/boot/grub/menu.lst<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br />title           Debian GNU/Linux, kernel 2.6.15-1-686<br />root            (cd)<br />kernel          /boot/vmlinuz boot=cramfs root=/dev/cdrom 1<br />initrd          /boot/initrd.img<br />boot<br />### END DEBIAN AUTOMAGIC KERNELS LIST<br />title           from Harddisk<br />root            (hd0)<br />chainloader +1<br />boot<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br />        注意两个问题，一个千万不能找debian的默认配置学savedefault[1]。都光驱了你还save个啥阿？还有就是root行可以省略，不过我还是放出来。<br />    3.kernel &amp; initrd<br />        注意到上面的initrd了吧，这个东西本来是用来启动内核的。先加载initrd，然后加载驱动，初始化，然后内核切换到root再启动init。不过在2.6内核中，有一种cpio-initrd[2]。这种东西可以直接当做内存盘用，端的是爽歪歪。把内容先用cpio打包，再gzip压缩就好了。不过内存盘中的内容建议能精简就精简，而且注意，文献[2]中的内容用的参数是cpio -c -o。根据我的试验，2.6.15内核不认可pre-SRV4格式的cpio-initrd。debian默认的是SRV4 non-CRC的，所以我们使用cpio -H newc -o参数[3]。<br />        然后就是initrd的内容，我们使用标准的initrd解压后自己mod。首先是把tar复制到bin下面，因为等等我们会在生成root的时候使用tar（如果你觉得只有1M不到不用压缩也可以，不过要手工生成很多连接，最好还是用tar打个包，比较方便）。其次，如果需要用cramfs方式的，要记得把loop.o内核模块也放到initrd的对应位置。否则没有loop设备是不能挂载的。然后我们在scripts下面生成一个cramfs文件，不需要可执行。<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br /># Local filesystem mounting                     -<em>- shell-script -</em>-<br /># Parameter: Where to mount the filesystem<br />mountroot ()<br />{<br />        [ &quot;$quiet&quot; != &quot;y&quot; ] &amp;&amp; log_begin_msg &quot;Running /scripts/local-top&quot;<br />        run_scripts /scripts/local-top<br />        [ &quot;$quiet&quot; != &quot;y&quot; ] &amp;&amp; log_end_msg<br />        [ &quot;$quiet&quot; != &quot;y&quot; ] &amp;&amp; log_begin_msg &quot;Running /scripts/local-premount&quot;<br />        run_scripts /scripts/local-premount<br />        [ &quot;$quiet&quot; != &quot;y&quot; ] &amp;&amp; log_end_msg<br />       # We&rsquo;ve given up, but we&rsquo;ll let the user fix matters if they can<br />        while [ ! -e &quot;${ROOT}&quot; ]; do<br />                panic &quot;ALERT!  ${ROOT} does not exist.  Dropping to a shell!&quot;<br />        done<br />        mkdir /mnt<br />        mount -n -t iso9660 -r -o exec ${ROOT} /mnt<br />        mount -n -t ramfs none ${rootmnt}<br />        if [ ! -e /mnt/boot/root.tar.gz ]; then<br />                echo &quot;no root.tar.gz&quot;<br />        fi<br />        tar xzf /mnt/boot/root.tar.gz -C ${rootmnt}<br />        mount -n -o move /mnt ${rootmnt}/cdrom<br />        modprobe loop<br />        mknod /dev/loop0 b 7 0<br />        mount -t cramfs -o loop ${rootmnt}/cdrom/cdrom.cramfs ${rootmnt}/media<br />        [ &quot;$quiet&quot; != &quot;y&quot; ] &amp;&amp; log_begin_msg &quot;Running /scripts/log-bottom&quot;<br />        run_scripts /scripts/local-bottom<br />        [ &quot;$quiet&quot; != &quot;y&quot; ] &amp;&amp; log_end_msg<br />}<br />&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;我是邪恶的分割线&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;<br />        然后我们看上面~/syscd/boot/grub/menu.lst的内核参数，现在知道为什么要boot=cramfs了吧。至于root，如果你是双光驱，那么cdrom可能指向错误的光驱。在grub的时候手工调整参数就照样启动了。至于那个1，是用来进入单用户模式的，虽然我其实在/etc/inittab里面调整了。<br />        cramfs首先套用了local启动方式的外壳脚本，然后在挂载的时候，先吧ROOT设备挂载到/mnt，这是initrd的一个空目录。然后再在目标位置挂载一个ramfs。然后检查光盘上的boot/root.tar.gz。用刚刚我们说的tar解压到目标位置。再把/mnt下面的光盘移动挂载到目标目录的cdrom下面（如果不用cramfs，就移动到media，因为root中制作的所有连接都指向了media下面）。<br />        [5]cramfs是一种压缩只读文件格式，做光盘live的时候最适合使用，我们假定做了一个cdrom.cramfs放在光盘根目录下面（这个其实是用mksyscd自动把cramfs目录生成出来的）。这个时候挂载就好了，指令不复杂。不过挂载前要</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn"></span></span>
    
    <time>Jul 11, 2006</time>
    <span class="categories">
      Tags:
        
        
          <a class="category" href="http://shell909090.org/tags/debian">debian</a>  <a class="category" href="http://shell909090.org/tags/linux">linux</a>  
        
    </span>
  </p>

  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://shell909090.org/blog/archives/306/" title="linux中文说">linux中文说</a>
    

    
      <a class="basic-alignment right" href="http://shell909090.org/blog/archives/308/" title="论linux引导过程">论linux引导过程</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'shell909090blog';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      
      
      
       
      
      
      
      
      

    
    
    </li>
  </ul>

  

  

  
  
  
    <section class="even">
      <h1>Recent Posts</h1>
      <ul id="recent_posts">
        
          <li class="post">
            <a href="/blog/archives/2837/">更换blog声明</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2836/">Pulau Perhentian</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2835/">唐僧被吃了</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2832/">三亚潜水体验</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2829/">潜水的一些简单解说</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2822/">一个有趣的问题</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2820/">一次升级故障的排查</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2816/">关于程序员和产品经理两大世界体系的对话——论快播庭审</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2813/">云计算的成本计算</a>
          </li>
        
          <li class="post">
            <a href="/blog/archives/2809/">说说密码和安全设计</a>
          </li>
        
      </ul>
    </section>
  

</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2016  - <a href="http://shell909090.org/license/">License</a> -
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


</body>
</html>

